{% extends "base.html" %} {% block title %}{{ order.order_number }} - Jelita{%
endblock %} {% block content %}
<div class="mb-6">
  <a
    href="{{ url_for('orders') }}"
    class="text-rose-700 font-semibold hover:underline"
    >← Kembali ke Pesanan Saya</a
  >
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  <!-- Order Info -->
  <div class="lg:col-span-2 space-y-6">
    <!-- Order Header -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h1 class="text-3xl font-bold text-stone-900">
            {{ order.order_number }}
          </h1>
          <p class="text-stone-600">
            {{ order.created_at.strftime('%d %B %Y %H:%M') }}
          </p>
        </div>
        <div class="text-right">
          {% if order.status == 'pending' %}
          <span class="badge badge-warning">Menunggu Pembayaran</span>
          {% elif order.status == 'paid' %}
          <span class="badge badge-info">Dibayar</span>
          {% elif order.status == 'processing' %}
          <span class="badge badge-info">Diproses</span>
          {% elif order.status == 'shipped' %}
          <span class="badge badge-info">Dikirim</span>
          {% elif order.status == 'delivered' %}
          <span class="badge badge-success">Terkirim</span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Payment Status -->
    {% if order.status == 'pending' and order.payment_status == 'unpaid' %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
      <div class="flex items-start gap-4">
        <svg
          class="w-6 h-6 text-yellow-600 flex-shrink-0"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
            clip-rule="evenodd"
          />
        </svg>
        <div>
          <h3 class="font-semibold text-yellow-900 mb-2">
            Pembayaran Diperlukan
          </h3>
          <p class="text-yellow-800 text-sm mb-4">
            Pesanan Anda belum dibayar. Silakan lakukan pembayaran untuk
            melanjutkan.
          </p>
          <button
            id="pay-button"
            class="bg-rose-700 text-white px-6 py-2 rounded-lg hover:bg-rose-800 transition-colors"
          >
            Lanjutkan Pembayaran
          </button>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Order Timeline -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-lg font-bold text-stone-900 mb-6">Status Pengiriman</h2>

      <div class="space-y-4">
        <div class="flex gap-4">
          <div class="flex flex-col items-center">
            <div
              class="w-10 h-10 rounded-full bg-rose-700 text-white flex items-center justify-center font-bold"
            >
              ✓
            </div>
            <div class="w-1 h-12 bg-stone-300 my-2"></div>
          </div>
          <div>
            <p class="font-semibold text-stone-900">Pesanan Dikonfirmasi</p>
            <p class="text-stone-600 text-sm">
              {{ order.created_at.strftime('%d %B %Y %H:%M') }}
            </p>
          </div>
        </div>

        <div class="flex gap-4">
          <div class="flex flex-col items-center">
            <div
              class="w-10 h-10 rounded-full {% if order.status in ['processing', 'shipped', 'delivered'] %}bg-rose-700 text-white{% else %}bg-stone-300 text-stone-600{% endif %} flex items-center justify-center font-bold"
            >
              {% if order.status in ['processing', 'shipped', 'delivered'] %}✓{%
              else %}2{% endif %}
            </div>
            <div class="w-1 h-12 bg-stone-300 my-2"></div>
          </div>
          <div>
            <p class="font-semibold text-stone-900">Diproses</p>
            <p class="text-stone-600 text-sm">
              {% if order.status in ['processing', 'shipped', 'delivered'] %}{{
              order.updated_at.strftime('%d %B %Y') }}{% else %}Menunggu...{%
              endif %}
            </p>
          </div>
        </div>

        <div class="flex gap-4">
          <div class="flex flex-col items-center">
            <div
              class="w-10 h-10 rounded-full {% if order.status in ['shipped', 'delivered'] %}bg-rose-700 text-white{% else %}bg-stone-300 text-stone-600{% endif %} flex items-center justify-center font-bold"
            >
              {% if order.status in ['shipped', 'delivered'] %}✓{% else %}3{%
              endif %}
            </div>
            <div class="w-1 h-12 bg-stone-300 my-2"></div>
          </div>
          <div>
            <p class="font-semibold text-stone-900">Dikirim</p>
            <p class="text-stone-600 text-sm">
              {% if order.tracking_number %} Resi: {{ order.tracking_number }}
              {% elif order.status in ['shipped', 'delivered'] %} {{
              order.updated_at.strftime('%d %B %Y') }} {% else %} Menunggu... {%
              endif %}
            </p>
          </div>
        </div>

        <div class="flex gap-4">
          <div class="flex flex-col items-center">
            <div
              class="w-10 h-10 rounded-full {% if order.status == 'delivered' %}bg-rose-700 text-white{% else %}bg-stone-300 text-stone-600{% endif %} flex items-center justify-center font-bold"
            >
              {% if order.status == 'delivered' %}✓{% else %}4{% endif %}
            </div>
          </div>
          <div>
            <p class="font-semibold text-stone-900">Terkirim</p>
            <p class="text-stone-600 text-sm">
              {% if order.status == 'delivered' %}{{
              order.updated_at.strftime('%d %B %Y') }}{% else %}Menunggu...{%
              endif %}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Items -->
    <div class="bg-white rounded-lg shadow-md p-6">
      <h2 class="text-lg font-bold text-stone-900 mb-4">Item Pesanan</h2>

      <div class="space-y-4">
        {% for item in order.items %}
        <div class="flex gap-4 pb-4 border-b border-stone-200">
          <img
            src="{{ item.image_url or '/placeholder.svg?height=100&width=100' }}"
            alt="{{ item.product_name }}"
            class="w-20 h-20 object-cover rounded-lg"
          />

          <div class="flex-1">
            <h3 class="font-semibold text-stone-900">
              {{ item.product_name }}
            </h3>
            <div class="text-sm text-stone-600 space-y-1">
              {% if item.color %}
              <p>Warna: {{ item.color }}</p>
              {% endif %} {% if item.size %}
              <p>Ukuran: {{ item.size }}</p>
              {% endif %}
              <p>
                Jumlah: {{ item.quantity }} x Rp {{
                "{:,.0f}".format(item.price).replace(',', '.') }}
              </p>
            </div>
          </div>

          <div class="text-right">
            <p class="font-bold text-stone-900">
              Rp {{ "{:,.0f}".format(item.quantity * item.price).replace(',',
              '.') }}
            </p>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Order Summary -->
  <div class="lg:col-span-1">
    <!-- Shipping Address -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <h3 class="font-bold text-stone-900 mb-4">Alamat Pengiriman</h3>
      <div class="text-sm text-stone-600 space-y-2">
        <p class="font-semibold text-stone-900">{{ current_user.username }}</p>
        <p>{{ order.shipping_address }}</p>
        <p>{{ order.shipping_city }}, {{ order.shipping_postal }}</p>
      </div>
    </div>

    <!-- Order Total -->
    <div class="bg-white rounded-lg shadow-md p-6 sticky top-24 space-y-4">
      <h3 class="font-bold text-stone-900">Ringkasan Total</h3>

      <div class="space-y-2 text-sm">
        <div class="flex justify-between">
          <span class="text-stone-600">Subtotal</span>
          <span
            >Rp {{ "{:,.0f}".format(order.total_amount - order.tax_amount -
            order.shipping_cost).replace(',', '.') }}</span
          >
        </div>
        <div class="flex justify-between">
          <span class="text-stone-600">Pajak</span>
          <span
            >Rp {{ "{:,.0f}".format(order.tax_amount).replace(',', '.') }}</span
          >
        </div>
        <div class="flex justify-between">
          <span class="text-stone-600">Pengiriman</span>
          <span
            >Rp {{ "{:,.0f}".format(order.shipping_cost).replace(',', '.')
            }}</span
          >
        </div>
      </div>

      <div class="border-t border-stone-200 pt-4">
        <div class="flex justify-between">
          <span class="font-bold">Total</span>
          <span class="font-bold text-rose-700 text-lg"
            >Rp {{ "{:,.0f}".format(order.total_amount).replace(',', '.')
            }}</span
          >
        </div>
      </div>

      <div class="pt-4 space-y-2 text-sm">
        <p class="text-stone-600">
          <strong>Metode Pembayaran:</strong> {{
          order.payment_method.replace('_', ' ').title() }}
        </p>
        <p class="text-stone-600">
          <strong>Status Pembayaran:</strong>
          {% if order.payment_status == 'paid' %}
          <span class="text-green-600 font-semibold">Sudah Dibayar</span>
          {% else %}
          <span class="text-red-600 font-semibold">Belum Dibayar</span>
          {% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

<script
  src="https://app.midtrans.com/snap/snap.js"
  data-client-key="YOUR_CLIENT_KEY"
></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const payButton = document.getElementById("pay-button");
    if (payButton) {
      payButton.addEventListener("click", function () {
        fetch(
          '{{ url_for("process_payment", order_number=order.order_number) }}',
          {
            method: "POST",
          }
        )
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              snap.pay(data.token, {
                onSuccess: function (result) {
                  window.location.href =
                    '{{ url_for("verify_payment_route", order_number=order.order_number) }}';
                },
              });
            }
          });
      });
    }
  });
</script>
{% endblock %}
